<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Details - Splitter</title>
    <link rel="stylesheet" href="/frontend/assets/css/style.css">
    <link rel="stylesheet" href="/frontend/assets/css/components.css">
    <link rel="stylesheet" href="/frontend/assets/css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="dashboard">
        <header class="dashboard-header">
            <div class="container">
                <div class="dashboard-header-content">
                    <h1 class="dashboard-title">Splitter</h1>
                    <nav class="dashboard-nav">
                        <a href="/frontend/dashboard.html" class="nav-link">Dashboard</a>
                        <a href="/frontend/groups/list.html" class="nav-link">Groups</a>
                        <a href="/frontend/profile.html" class="nav-link">Profile</a>
                        <button onclick="Auth.logout()" class="btn btn-outline btn-sm">Logout</button>
                    </nav>
                </div>
            </div>
        </header>

        <main class="container">
            <div id="loading" style="text-align: center; padding: var(--spacing-2xl);">
                <p>Loading group details...</p>
            </div>

            <div id="groupContent" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
                    <div>
                        <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                            <h2 class="section-title" style="margin: 0;" id="groupName"></h2>
                            <span id="closedBadge" class="badge badge-warning" style="display: none;">Closed</span>
                        </div>
                        <p style="color: var(--text-secondary); margin-top: var(--spacing-xs);" id="groupDescription"></p>
                    </div>
                    <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
                        <a href="#" id="addExpenseLink" class="btn btn-primary" style="display: none;">Add Expense</a>
                        <a href="#" id="mealTrackingLink" class="btn btn-secondary" style="display: none;">Meal Tracking</a>
                        <a href="#" id="analyticsLink" class="btn btn-secondary">Analytics</a>
                        <button id="closeGroupBtn" class="btn btn-outline" style="display: none;">Close Group</button>
                        <button id="deleteGroupBtn" class="btn btn-danger" style="display: none;">Delete Group</button>
                    </div>
                </div>

                <div class="card" style="margin-bottom: var(--spacing-lg);">
                    <div class="card-body">
                        <h3 style="margin-bottom: var(--spacing-md);">Members</h3>
                        <div id="membersList"></div>
                        <div style="margin-top: var(--spacing-md);">
                            <button id="inviteBtn" class="btn btn-outline btn-sm" style="display: none;">Invite Member</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Expenses</h3>
                    </div>
                    <div class="card-body">
                        <div id="expensesList">
                            <p style="color: var(--text-secondary); text-align: center;">No expenses yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Invite Modal -->
    <div id="inviteModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Invite Member</h3>
                <button class="modal-close" onclick="closeInviteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="inviteForm">
                    <div class="form-group">
                        <label for="inviteEmail" class="form-label required">Email Address</label>
                        <input type="email" id="inviteEmail" class="form-input" required>
                    </div>
                    <div class="form-group" style="display: flex; gap: var(--spacing-md); justify-content: flex-end; margin-top: var(--spacing-xl);">
                        <button type="button" onclick="closeInviteModal()" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send Invitation</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/frontend/assets/js/api.js"></script>
    <script src="/frontend/assets/js/auth.js"></script>
    <script src="/frontend/assets/js/utils.js"></script>
    <script src="/frontend/assets/js/groups.js"></script>
    <script>
        let groupId = Utils.getURLParam('id');
        let currentGroup = null;
        
        Auth.requireAuth().then(async (authenticated) => {
            if (!authenticated || !groupId) {
                window.location.href = '/frontend/groups/list.html';
                return;
            }
            
            await loadGroupDetails();
        });
        
        async function loadGroupDetails() {
            currentGroup = await Groups.getGroup(groupId);
            
            if (!currentGroup) {
                await Utils.showError('Group not found');
                setTimeout(() => {
                    window.location.href = '/frontend/groups/list.html';
                }, 2000);
                return;
            }
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('groupContent').style.display = 'block';
            
            // Populate group info
            document.getElementById('groupName').textContent = currentGroup.name;
            document.getElementById('groupDescription').textContent = currentGroup.description || 'No description';
            
            const user = Auth.getUser();
            const isCreator = user && currentGroup.creator_id == user.user_id;
            const isClosed = currentGroup.is_closed == 1 || currentGroup.is_closed === true;
            
            // Show closed badge if group is closed
            if (isClosed) {
                document.getElementById('closedBadge').style.display = 'inline-block';
            }
            
            // Update links - Analytics always available, even for closed groups
            document.getElementById('analyticsLink').href = `/frontend/analytics/dashboard.html?group_id=${groupId}`;
            
            // Meal tracking link (always available, but closed groups are read-only)
            document.getElementById('mealTrackingLink').href = `/frontend/meals/tracking.html?group_id=${groupId}`;
            document.getElementById('mealTrackingLink').style.display = 'inline-block';
            
            // Show/hide buttons based on group status
            if (!isClosed) {
                // Group is open - show add expense and invite buttons
                document.getElementById('addExpenseLink').style.display = 'inline-block';
                document.getElementById('addExpenseLink').href = `/frontend/expenses/add.html?group_id=${groupId}`;
                document.getElementById('inviteBtn').style.display = 'inline-block';
                
                // Show close button for creator
                if (isCreator) {
                    document.getElementById('closeGroupBtn').style.display = 'inline-block';
                    document.getElementById('closeGroupBtn').onclick = async () => {
                        const confirmed = await Utils.confirm(
                            'Close Group?',
                            'You can still view analytics and generate PDFs, but cannot add new expenses or invite members.',
                            'Yes, Close Group',
                            'Cancel'
                        );
                        if (confirmed) {
                            const result = await Groups.closeGroup(groupId);
                            if (result.success) {
                                await Utils.showSuccess('Group closed successfully');
                                await loadGroupDetails();
                            } else {
                                await Utils.showError(result.message);
                            }
                        }
                    };
                }
            } else {
                // Group is closed - hide add expense and invite buttons
                document.getElementById('addExpenseLink').style.display = 'none';
                document.getElementById('inviteBtn').style.display = 'none';
                
                // Show delete button for creator (only on closed groups)
                if (isCreator) {
                    document.getElementById('deleteGroupBtn').style.display = 'inline-block';
                    document.getElementById('deleteGroupBtn').onclick = async () => {
                        const confirmed = await Utils.confirmDelete(`group "${currentGroup.name}"`);
                        if (confirmed) {
                            const result = await Groups.deleteGroup(groupId);
                            if (result.success) {
                                await Utils.showSuccess('Group deleted successfully');
                                setTimeout(() => {
                                    window.location.href = '/frontend/groups/list.html';
                                }, 1500);
                            } else {
                                await Utils.showError(result.message);
                            }
                        }
                    };
                }
            }
            
            // Render members
            renderMembers(currentGroup.members || []);
            
            // Load expenses
            await loadExpenses();
        }
        
        function renderMembers(members) {
            const container = document.getElementById('membersList');
            if (members.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No members</p>';
                return;
            }
            
            container.innerHTML = members.map(member => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-sm) 0; border-bottom: 1px solid var(--border-color);">
                    <div>
                        <strong>${Utils.escapeHtml(member.name)}</strong>
                        <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">${Utils.escapeHtml(member.email)}</div>
                    </div>
                </div>
            `).join('');
        }
        
        async function loadExpenses() {
            try {
                const response = await API.get('/expenses/list.php', {
                    group_id: groupId,
                    page: 1,
                    page_size: 10
                });
                
                const container = document.getElementById('expensesList');
                const expenses = response.data?.expenses || [];
                
                if (expenses.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No expenses yet</p>';
                    return;
                }
                
                const user = Auth.getUser();
                const userId = user ? user.user_id : null;
                
                container.innerHTML = expenses.map(expense => {
                    const canDelete = !currentGroup.is_closed && expense.paid_by_user_id == userId;
                    return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-md) 0; border-bottom: 1px solid var(--border-color);">
                        <div style="flex: 1;">
                            <strong>${Utils.escapeHtml(expense.description || 'No description')}</strong>
                            <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">
                                Paid by ${Utils.escapeHtml(expense.paid_by_name)} on ${Utils.formatDate(expense.expense_date)}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                            <div style="font-weight: 600; color: var(--primary-color);">
                                ${Utils.formatCurrency(expense.amount)}
                            </div>
                            ${canDelete ? `
                                <button class="btn btn-outline btn-sm delete-expense-btn" data-expense-id="${expense.expense_id}" style="padding: 4px 8px; font-size: 0.85em;">
                                    Delete
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                }).join('');
                
                // Add delete event listeners
                if (!currentGroup.is_closed) {
                    container.querySelectorAll('.delete-expense-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const expenseId = parseInt(e.target.dataset.expenseId);
                            await deleteExpense(expenseId);
                        });
                    });
                }
            } catch (error) {
                // Silently fail - expenses section will remain empty
            }
        }
        
        async function deleteExpense(expenseId) {
            const confirmed = await Utils.confirmDelete(
                'Delete Expense?',
                'Are you sure you want to delete this expense? This action cannot be undone.'
            );
            if (!confirmed) {
                return;
            }
            
            try {
                const result = await Expenses.deleteExpense(expenseId);
                if (result.success) {
                    await Utils.showSuccess('Expense deleted successfully!');
                    await loadExpenses();
                    // Reload group details to update total amount
                    await loadGroupDetails();
                } else {
                    await Utils.showError(result.message || 'Failed to delete expense');
                }
            } catch (error) {
                await Utils.showError(error.message || 'Failed to delete expense');
            }
        }
        
        // Invite modal
        document.getElementById('inviteBtn').onclick = () => {
            document.getElementById('inviteModal').style.display = 'flex';
        };
        
        function closeInviteModal() {
            document.getElementById('inviteModal').style.display = 'none';
            document.getElementById('inviteForm').reset();
        }
        
        document.getElementById('inviteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('inviteEmail').value.trim();
            
            if (!Utils.validateEmail(email)) {
                await Utils.showError('Please enter a valid email address');
                return;
            }
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            Utils.showLoading(submitBtn);
            
            const result = await Groups.inviteUser(groupId, email);
            
            if (result.success) {
                await Utils.showSuccess('Invitation sent successfully!');
                closeInviteModal();
            } else {
                await Utils.showError(result.message || 'Failed to send invitation');
                Utils.hideLoading(submitBtn);
            }
        });
    </script>
</body>
</html>

